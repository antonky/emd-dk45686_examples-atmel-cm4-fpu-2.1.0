<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DK45686 eMD examples User Guide: algo_agm and algo_agm_dynprot</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="TDK_theme.css" rel="stylesheet" type="text/css"/>
<link href="TDK_override_banner_color.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="TDK_Logo_white.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DK45686 eMD examples User Guide
   &#160;<span id="projectnumber">2.1.0</span>
   </div>
   <div id="projectbrief">Documentation of the DK45686 eMD examples</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00054.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">algo_agm and algo_agm_dynprot </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This application showcases how to use AGM Sensor Fusion library with our IMU and, optionally, AK09915 magnetometer.</p>
<p>Two projects are provided, both based on the same source code (algo_agm.c):</p><ul>
<li><b>algo_agm</b>: Processes sensors data through the AGM library and prints outputs to a terminal as ASCII char. Commands can be sent through the terminal.</li>
<li><b>algo_agm_dynprot</b>: Processes sensors data through the AGM library and sends output via a binary protocol to the host (Windows or Linux). A dedicated tool (sensorcli) is required.</li>
</ul>
<p>Fixed sensor configuration:</p><ul>
<li>Accel and Gyro set to 400 Hz ODR in Low Noise mode.</li>
<li>Sensor data are read from the FIFO in highres mode.</li>
<li>INT1 is asserted for each frame pushed in FIFO.</li>
<li>If AK09915 DB is connected, Mag data are retrieved through sensor registers at 100 Hz. Acquisition is synchronized with IMU interrupt.</li>
</ul>
<h1><a class="anchor" id="autotoc_md65"></a>
Commonalities</h1>
<h2><a class="anchor" id="autotoc_md66"></a>
Calibration procedures</h2>
<p>For optimal performances, please proceed to sensors calibration:</p><ul>
<li>To calibrate the gyroscope, keep the board still for ~1 second.</li>
<li>To calibrate the accelerometer, keep the board still on at least 4 different faces for ~1 second.</li>
<li>To calibrate the magnetometer, do 8-shape movement (the board should rotate around all 3 axis).</li>
</ul>
<p>A calibration accuracy flag, ranging from 0 (not calibrated) to 3 (maximum accuracy), is provided for each sensors (accelerometer, gyroscope and magnetometer).</p>
<h2><a class="anchor" id="autotoc_md67"></a>
Saving and loading calibration in flash</h2>
<p>In order to speed up calibration, it is recommended to save sensors offsets in flash and restore them at startup. The application provided showcases how to do that by looking in a dedicated flash area for existing offsets. If offsets are found, algorithm will be initialized with the corresponding value, otherwise, it will consider offsets are 0. Once the application is running, as soon as all sensors (accel, gyro and optionally mag) are calibrated (e.g. calibration flag is 3), the offsets will be written in the dedicated flash area for the next execution. Writing in flash is time consuming and therefore, we will only write the offsets once per hour.</p>
<h2><a class="anchor" id="autotoc_md68"></a>
Connecting AK09915 Daughter-Board</h2>
<p>If you need an AK09915 DB, please contact your TDK-InvenSense representative. It shall be connected on the "Other Sensor DB" connectors (CN2 and CN3).</p>
<p>If the IMU is connected in SPI, please:</p><ul>
<li>On DK board, J1 connector: open pins 1-2 and 3-4 and short pins 5-6 and 7-8.</li>
<li>On AK09915 DB board, J1 connector: short pins 1-2 and 3-4 and open pins 5-6 and 7-8.</li>
</ul>
<p>If the IMU is connected in I2C, please:</p><ul>
<li>On DK board, J1 connector: short pins 1-2 and 3-4 and open pins 5-6 and 7-8.</li>
<li>On AK09915 DB board, J1 connector: open pins 1-2 and 3-4 and short pins 5-6 and 7-8.</li>
</ul>
<h2><a class="anchor" id="autotoc_md69"></a>
Mounting Matrix</h2>
<p>If AK09915 is being used, a mounting matrix will be applied to the mag data to convert it to the same reference frame as the IMU. If you are not using the standard setup, please consider updating <code>mag_matrix[9]</code> array in <em>algo_agm.c</em>.</p>
<h1><a class="anchor" id="autotoc_md70"></a>
Specificities of algo_agm</h1>
<h2><a class="anchor" id="autotoc_md71"></a>
Command interface</h2>
<p>A command interface is provided. You can send the following characters to UART:</p><ul>
<li><code>i</code>: to show (or hide) algo's input data (raw accel, raw gyro and raw mag).</li>
<li><code>a</code>: to show (or hide) calibrated accel data.</li>
<li><code>g</code>: to show (or hide) calibrated gyro data.</li>
<li><code>m</code>: to show (or hide) calibrated mag data.</li>
<li><code>9</code>: to show (or hide) 9-axis quaternion and Euler angles (Rotation Vector: RV).</li>
<li><code>6</code>: to show (or hide) 6-axis quaternion and Euler angles (Game Rotation Vector: GRV).</li>
<li><code>G</code>: to show (or hide) gravity estimation in sensor frame.</li>
<li><code>l</code>: to show (or hide) linear acceleration estimation in sensor frame.</li>
<li><code>f</code>: to configure printing period to fast (every 20 ms).</li>
<li><code>s</code>: to configure printing period to slow (every 1 s).</li>
<li><code>R</code>: to reset biases and accuracies.</li>
<li><code>h</code>: to print help screen.</li>
</ul>
<h2><a class="anchor" id="autotoc_md72"></a>
Terminal output</h2>
<h3><a class="anchor" id="autotoc_md73"></a>
Data format</h3>
<p>Data are printed on the terminal as follow:</p>
<div class="fragment"><div class="line">&lt;timestamp&gt;: INPUT  RAcc=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;] RGyr=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;] Rtemp=[&lt;t&gt;]</div>
<div class="line">&lt;timestamp&gt;: INPUT  RMag=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]</div>
<div class="line">&lt;timestamp&gt;: OUTPUT Acc=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]g AccBias=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]mg Accuracy=&lt;a&gt;</div>
<div class="line">&lt;timestamp&gt;: OUTPUT Gyr=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]dps GyrBias=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]dps Temp=[&lt;t&gt;]C Accuracy=&lt;a&gt;</div>
<div class="line">&lt;timestamp&gt;: OUTPUT Mag=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]uT MagBias=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;]uT Accuracy=&lt;a&gt;</div>
<div class="line">&lt;timestamp&gt;: OUTPUT 6Axis=[&lt;qw&gt;, &lt;qx&gt;, &lt;qy&gt;, &lt;qz&gt;]</div>
<div class="line">&lt;timestamp&gt;: OUTPUT Euler6Axis=[&lt;y&gt;, &lt;p&gt;, &lt;r&gt;]deg</div>
<div class="line">&lt;timestamp&gt;: OUTPUT 9Axis=[&lt;qw&gt;, &lt;qx&gt;, &lt;qy&gt;, &lt;qz&gt;] 9AxisAccuracy=[&lt;ha&gt;]deg</div>
<div class="line">&lt;timestamp&gt;: OUTPUT Euler9Axis=[&lt;y&gt;, &lt;p&gt;, &lt;r&gt;]deg 9AxisAccuracy=[&lt;ha&gt;]deg</div>
<div class="line">&lt;timestamp&gt;: OUTPUT Gravity=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;] Accuracy=&lt;a&gt;</div>
<div class="line">&lt;timestamp&gt;: OUTPUT LinearAcc=[&lt;x&gt;, &lt;y&gt;, &lt;z&gt;] Accuracy=&lt;a&gt;</div>
</div><!-- fragment --><p>With:</p><ul>
<li><code>&lt;timestamp&gt;</code>: Time in microsecond read from MCU clock.</li>
<li><code>&lt;x|y|z&gt;</code>: Sensor data on X, Y and Z axis.</li>
<li><code>&lt;t&gt;</code>: Temperature data.</li>
<li><code>&lt;a&gt;</code>: Accuracy flag reported by algo (from 0 to 3).</li>
<li><code>&lt;qw|qx|qy|qz&gt;</code>: Rotation vector computed by algo as quaternion.</li>
<li><code>&lt;y|p|r&gt;</code>: Euler angles as Yaw, Pitch and Roll.</li>
<li><code>&lt;ha&gt;</code>: Estimation of the Heading Accuracy of the 9-axis fusion in degrees.</li>
</ul>
<h3><a class="anchor" id="autotoc_md74"></a>
Example of output</h3>
<div class="fragment"><div class="line">[I] ###</div>
<div class="line">[I] ### Example Algo AGM</div>
<div class="line">[I] ###</div>
<div class="line">[I] IMU successfully initialized</div>
<div class="line">[I] Mag (AK09915) successfully initialized</div>
<div class="line">[I] Algo AGM 2.2.5 successfully initialized</div>
<div class="line">[I] </div>
<div class="line">[I] 556548: OUTPUT Acc=[-0.408, -0.032, 0.921]g AccBias=[0.000, 0.000, 0.000]mg Accuracy=0</div>
<div class="line">[I] 556548: OUTPUT Gyr=[0.336, -0.099, 0.122]dps GyrBias=[0.000, 0.000, 0.000]dps Temp=[23.00]C Accuracy=0</div>
<div class="line">[I] 994450: OUTPUT Mag=[395.084, 252.740, -261.739]uT MagBias=[0.000, 0.000, 0.000]uT Accuracy=0</div>
<div class="line">[I] 556548: OUTPUT 6Axis=[0.978329, -0.015994, 0.206439, -0.000181]</div>
<div class="line">[I] 556548: OUTPUT Euler6Axis=[0.44, 1.97, 23.82]deg</div>
<div class="line">[I] 556548: OUTPUT 9Axis=[0.899239, -0.096028, 0.183425, 0.385362] 9AxisAccuracy=[16.533419]deg</div>
<div class="line">[I] 556548: OUTPUT Euler9Axis=[-45.98, 1.96, 23.82]deg 9AxisAccuracy=[16.533419]deg</div>
<div class="line">[I] </div>
<div class="line">[I] 1554917: OUTPUT Acc=[-0.406, -0.032, 0.923]g AccBias=[0.000, 0.000, 0.000]mg Accuracy=0</div>
<div class="line">[I] 1554917: OUTPUT Gyr=[0.015, 0.024, -0.093]dps GyrBias=[0.336, -0.124, 0.062]dps Temp=[23.13]C Accuracy=3</div>
<div class="line">[I] 2000278: OUTPUT Mag=[394.634, 251.690, -261.439]uT MagBias=[0.000, 0.000, 0.000]uT Accuracy=0</div>
<div class="line">[I] 1554917: OUTPUT 6Axis=[0.978293, -0.016421, 0.206573, -0.000360]</div>
<div class="line">[I] 1554917: OUTPUT Euler6Axis=[0.47, 2.02, 23.84]deg</div>
<div class="line">[I] 1554917: OUTPUT 9Axis=[0.899171, -0.096545, 0.183361, 0.385422] 9AxisAccuracy=[15.532701]deg</div>
<div class="line">[I] 1554917: OUTPUT Euler9Axis=[-45.98, 2.02, 23.84]deg 9AxisAccuracy=[15.532701]deg</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md75"></a>
Algo AGM visualizer</h2>
<p>To visualize the algorithm outputs, an executable is provided. Please disconnect your terminal and run the <em>win/algo-agm-vizualizer.exe</em> application.</p>
<p><img src="algo-agm-visualizer.png" alt="" class="inline"/></p>
<p>On the top-left corner, set the FTDI port number on the <em>Serial port</em> field then click <em>Connect</em>. The FTDI port number is identified as "USB Serial Port (COMXX)" in <em>Device Manager</em> application.</p>
<p>The application receives the firmware traces and parses them to display data. Features can be enabled or disabled by sending letters to the firmware. The <em>UART Input</em> item is used for that purpose.</p>
<p>The <em>Set Reference</em> and <em>Clear Reference</em> buttons can be used to align the orientation to an initial position. It will apply to both the quaternion (visualized by the cube) and the Euler angles. Please note that the Euler angles represented on this application are calculated from the quaternion and can slightly differ from the value reported by the firmware.</p>
<p>On the top-right corner of the plots (accel, gyro, and mag), 3 squares represent the quality of the calibration. For a given sensor, the calibration is considered as completed when all 3 squares are green.</p>
<h1><a class="anchor" id="autotoc_md76"></a>
Specificities of algo_agm_dynprot</h1>
<p>When using the dynamic protocol variant, data are sent through the FTDI port with a binary protocol (called dynamic protocol). Sensorcli is required to control the firmware.</p>
<p>Please run sensorcli application on your computer (<em>win/sensorcli/sensor-cli.exe</em>).</p>
<p>Note that to prevent data loss during log, it is recommended to disable calibration saving (see configuration capabilities). Indeed, when writing calibration data into flash, the firmware is stalled for a long duration, that could eventually lead to data loss.</p>
<h2><a class="anchor" id="autotoc_md77"></a>
Command interface</h2>
<p>You can send the following commands from sensorcli:</p><ul>
<li><code>exit</code>: reset algorithm, bias and accuracy, then exit sensorcli.</li>
<li><code>setconfig gyr 32=&lt;mult&gt;</code>: multiply biases in ugyr and umag output by <code>&lt;mult&gt;</code>. Recommended value for <code>mult</code> is 256.</li>
<li><code>setconfig gyr 33=0</code>: disable calibration saving.</li>
<li><code>setconfig gyr 33=1</code>: enable calibration saving. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Jul 25 2024 08:14:38 for DK45686 eMD examples User Guide by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
